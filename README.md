# Домашнее задание 5

## Customer report service

Проблема:
Некоторые покупатели хотят иметь возможность выгружать историю заказов в формате [CSV](https://ru.wikipedia.org/wiki/CSV).

> Допущение. Так как в `Customer Service` нет возможности фильтровать по датам, то и отчет мы будем запрашивать сразу за все время.

Требования:

1. REST метод, который будет принимать id покупателя (customer_id) и возвращать отчет в формате [CSV](https://ru.wikipedia.org/wiki/CSV).
2. Данные о заказах следует получать из `Order Service`.
3. Сервис должен иметь систему **RateLimit**, которая ограничит количество одновременно обрабатываемых запросов до **N** штук. **N** определяется в `appsetting.json`. **N** по умолчанию равно *2*. Если количество одновременных запросов превышает **N**, то мы просто держим соединение, пока не сможем обработать.
> ASP.NET имеет уже готовую реализацию [RateLimit](https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit). Для целей обучения мы просим вас сделать свою простую реализацию RateLimit, при которой мы просто ограничиваем уровень параллельной обработки.
4. Единовременно по одному покупателю (customer) может формироваться только 1 отчет. Если в момент формирования отчета к нам поступит новый запрос, то мы должны завершить формирование старого отчета и начать новое формирование.
	
    > Например: Пользователь запросил отчет через браузер на вкладке 1. Пока отчет формировался, пользователь уже из вкладки 2 запросил еще один отчет. 
	Система должна завершить формирование отчета, который был запущен из вкладки 1, вернув ошибку. Формирование отчета для вкладки 2 должно продолжиться.
	
    > Подсказка: Тут может помочь `CancellationTokenSource`.
5. Если клиент обрывает соединение, то мы должны прекратить формировать отчет, так как никто уже не ждет ответа.
6. В сервисе обязательно должен быть `Swagger`.
7. Вся логика в сервисе должна быть **потокобезопасной**.

Формат CSV

|Id заказа|Статус|Коммент|Дата создания|
|---------|------|-------|-------------|
|long     |text  |text   |datetime     | 

## Дополнительное задание
Разбить запрос в `Order Service` на батчи для распараллеливания запроса. Команда `Order Service` попросила ограничить количество одновременных подключений до 20.

## Советы
1. Чаще всего вместо статики лучше использовать `singleton`.
2. Если `singleton`/статика содержит состояние, то следует быть крайне внимательными к потокобезопасности, особенно у коллекций.
3. Не забывайте, что надо освобождать ресурсы (оборачивать в `using` или вызывать `Dispose()`) у таких объектов как 
    * `CancellationTokenSource`
    * `Stream`
    * `Semaphore` 
    *  etc...
4. Для формирования CSV вы можете использовать [CsvHelper](https://joshclose.github.io/CsvHelper)

### Дедлайны сдачи и проверки задания:
- 22 марта 23:59 (сдача) / 25 марта, 23:59 (проверка)
